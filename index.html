<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>פרופיל לומד הוליסטי - מיומנויות וזום</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap');
        
        body { font-family: 'Heebo', sans-serif; user-select: none; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Fly Out Animation */
        .animate-flyOut {
          animation: flyOut 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
          opacity: 0;
          left: var(--start-x);
          top: var(--start-y);
          transform: translate(-50%, -50%) scale(0.2);
        }

        @keyframes flyOut {
          to {
            opacity: 1;
            left: var(--end-x);
            top: var(--end-y);
            transform: translate(-50%, -50%) scale(1);
          }
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Cursor styles for Pan/Zoom */
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
    </style>
</head>
<body class="bg-slate-50 h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useLayoutEffect, useMemo, useCallback } = React;

        // --- ICONS ---
        const IconBase = ({ size = 24, children, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );

        const Icons = {
            User: (p) => <IconBase {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>,
            BookOpen: (p) => <IconBase {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>,
            Brain: (p) => <IconBase {...p}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></IconBase>,
            Heart: (p) => <IconBase {...p}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></IconBase>,
            Activity: (p) => <IconBase {...p}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconBase>,
            Target: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>,
            Compass: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></IconBase>,
            Zap: (p) => <IconBase {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>,
            Sparkles: (p) => <IconBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 5h4"/><path d="M3 7.502h4"/><path d="M7 3.502v4"/></IconBase>,
            X: (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>,
            Database: (p) => <IconBase {...p}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></IconBase>,
            Info: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconBase>,
            FileText: (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></IconBase>,
            Users: (p) => <IconBase {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>,
            PenTool: (p) => <IconBase {...p}><path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/></IconBase>
        };

        // --- DATA STRUCTURE ---
        // Refactored Skills to be hierarchical: Skills -> Categories -> Metrics
        const rawData = [
          {
            id: 'personal',
            title: 'נתונים אישיים',
            icon: <Icons.User size={24} />,
            color: 'from-blue-400 to-blue-600',
            bgSolid: 'bg-blue-500',
            bgColor: 'bg-blue-100',
            borderColor: 'border-blue-200',
            textColor: 'text-blue-800',
            subDomains: [
              { title: 'נתונים דמוגרפיים', metrics: 'גיל, מגדר, שכבת גיל, שפת אם, סטטוס משפחתי של ההורים, מצב סוציואקונומי', source: 'נתוני בית ספר', stage: 1 },
              { title: 'תחומי עניין', metrics: 'תחביבים, תחומי עניין אישיים, כישורים מיוחדים', source: 'דיווח עצמי תלמיד', stage: 1 },
              { title: 'התאמות בלמידה', metrics: 'התאמות פדגוגיות או טכנולוגיות', source: 'נתוני בית ספר', stage: 2 }
            ]
          },
          {
            id: 'personality',
            title: 'מאפיינים אישיותיים',
            icon: <Icons.Sparkles size={24} />,
            color: 'from-purple-400 to-purple-600',
            bgSolid: 'bg-purple-500',
            bgColor: 'bg-purple-100',
            borderColor: 'border-purple-200',
            textColor: 'text-purple-800',
            subDomains: [
              { title: 'תכונות אישיות', metrics: 'פתיחות להתנסויות, מוחצנות, נועם הליכות, מצפוניות, יציבות רגשית', source: 'שאלון דיווח עצמי לתלמיד - TIPI', stage: 2 }
            ]
          },
          {
            id: 'knowledge',
            title: 'ידע',
            subtitle: 'מחולק למקצוע ולנושאי לימוד',
            icon: <Icons.BookOpen size={24} />,
            color: 'from-emerald-400 to-emerald-600',
            bgSolid: 'bg-emerald-500',
            bgColor: 'bg-emerald-100',
            borderColor: 'border-emerald-200',
            textColor: 'text-emerald-800',
            subDomains: [
              { title: 'רמת שליטה בידע ספציפי', metrics: 'ידע עולם, ידע קודם רלוונטי', source: 'נתוני למידה', stage: 1 },
              { title: 'התמודדות עם קושי', metrics: 'התמודדות עם רמת קושי של שאלה', source: 'נתוני למידה', stage: 1 },
              { title: 'רמת חשיבה', metrics: 'רמת חשיבה (זכירה, הבנה, יישום, אנליזה)', source: 'נתוני למידה', stage: 1 }
            ]
          },
          {
            id: 'skills',
            title: 'מיומנויות',
            icon: <Icons.Zap size={24} />,
            color: 'from-rose-400 to-rose-600',
            bgSolid: 'bg-rose-500',
            bgColor: 'bg-rose-100',
            borderColor: 'border-rose-200',
            textColor: 'text-rose-800',
            // Structure: Skills -> Categories -> Children (Metrics)
            subDomains: [
              {
                id: 'skills_social',
                title: 'חברתיות-רגשיות',
                isCategory: true,
                stage: 2, // General stage for category (or derived)
                children: [
                  { title: 'מיומנויות חברתיות', metrics: 'תקשורת - העברת מסר, עבודת צוות, מודעות והתנהלות חברתית', source: 'דיווח מורה', stage: 2 },
                  { title: 'מיומנויות רגשיות', metrics: 'מודעות עצמית, הכוונה עצמית', source: 'דיווח מורה', stage: 2 },
                  { title: 'מיומנויות תפקודיות', metrics: 'ניהול עצמי, חוסן, גמישות, קבלת החלטות', source: 'דיווח מורה', stage: 2 }
                ]
              },
              {
                id: 'skills_literacy',
                title: 'אורייניות',
                isCategory: true,
                stage: 2,
                children: [
                  { title: 'אוריינות לשונית', metrics: 'איתור מידע, פרשנות, הבעה בכתב ובעל פה', source: 'נתוני למידה', stage: 2 },
                  { title: 'חשיבה ביקורתית', metrics: 'טיעון', source: 'נתוני למידה', stage: 2 },
                  { title: 'חשיבה יצירתית', metrics: 'סקרנות, גמישות מחשבתית, הקשרים חדשים', source: 'נתוני למידה', stage: 2 },
                  { title: 'אוריינות דיגיטלית', metrics: 'תפעול, שיתופיות, יצירת תוכן דיגיטלי', source: 'נתוני למידה', stage: 2 },
                  { title: 'אוריינות מידע', metrics: 'איתור, הערכה, ארגון ושימוש במידע', source: 'נתוני למידה', stage: 2 }
                ]
              },
              {
                id: 'skills_disciplinary',
                title: 'דיסציפלינריות',
                isCategory: true,
                stage: 1,
                children: [
                  { title: 'מיומנויות דיסציפלינריות', metrics: '(רשימה נפרדת לכל תחום דעת)', source: 'נתוני למידה', stage: 1 }
                ]
              },
              {
                id: 'skills_meta',
                title: 'מטא-קוגניטיביות',
                isCategory: true,
                stage: 1, // Contains stage 1 items
                children: [
                   { title: 'תכנון למידה', metrics: 'תכנון מטרות, אסטרטגיות, זמן, משאבים', source: 'יומן למידה / MSLQ', stage: 2 },
                   { title: 'ויסות עצמי', metrics: 'ניטור הבנה, בקרה, תיקון אי-הבנה', source: 'MSLQ', stage: 2 },
                   { title: 'אסטרטגיות למידה', metrics: 'למידה שטחית/מעמיקה, שינון, עיבוד', source: 'MSLQ, RSPQ-2F', stage: 2 },
                   { title: 'מודעות לידע', metrics: 'שיפוט למידה, בטחון בתשובה (JOL, FOK)', source: 'JOL, JOU', stage: 1 }
                ]
              }
            ]
          },
          {
            id: 'self_beliefs',
            title: 'אמונות ביחס לעצמי',
            icon: <Icons.Target size={24} />,
            color: 'from-cyan-400 to-cyan-600',
            bgSolid: 'bg-cyan-500',
            bgColor: 'bg-cyan-100',
            borderColor: 'border-cyan-200',
            textColor: 'text-cyan-800',
            subDomains: [
              { title: 'מסוגלות עצמית ללמידה', metrics: '', source: 'MSLQ', stage: 1 },
              { title: 'תודעת צמיחה', metrics: '', source: 'ITIS-S', stage: 1 }
            ]
          },
          {
            id: 'social_emotional',
            title: 'רגשי-חברתי',
            icon: <Icons.Heart size={24} />,
            color: 'from-orange-400 to-orange-600',
            bgSolid: 'bg-orange-500',
            bgColor: 'bg-orange-100',
            borderColor: 'border-orange-200',
            textColor: 'text-orange-800',
            subDomains: [
              { title: 'צרכי עומק', metrics: 'קשר, שייכות, בטחון, אוטונומיה', source: 'שאלוני תצאמ', stage: 1 },
              { title: 'מוטיבציה', metrics: 'פנימית/חיצונית, עוצמה', source: 'MSLQ', stage: 1 },
              { title: 'הנאה מלמידה', metrics: 'רגש חיובי, עניין באתגור', source: 'PANAS-C', stage: 2 },
              { title: 'שייכות חברתית', metrics: 'שייכות לקבוצה/בי"ס', source: 'PSSM-H', stage: 2 },
              { title: 'רגש', metrics: 'חיוביות, אופטימיות, שעמום', source: 'PANAS-C', stage: 2 },
              { title: 'לחץ וחרדה', metrics: 'לחץ לימודי, חרדת בחינות', source: 'MAS-12', stage: 2 }
            ]
          },
          {
            id: 'srl',
            title: 'SRL וניהול למידה',
            icon: <Icons.Activity size={24} />,
            color: 'from-amber-400 to-amber-600',
            bgSolid: 'bg-amber-500',
            bgColor: 'bg-amber-100',
            borderColor: 'border-amber-200',
            textColor: 'text-amber-800',
            subDomains: [
              { title: 'מעורבות בלמידה', metrics: 'השתתפות בפעילויות ודיונים', source: 'נתוני למידה', stage: 1 },
              { title: 'התמדה', metrics: 'נוכחות, מאמץ, גריט (Grit)', source: 'Grit-S', stage: 1 },
              { title: 'סדירות למידה', metrics: 'זמני למידה, מניעת דחיינות', source: 'MSLQ', stage: 1 },
              { title: 'היעזרות', metrics: 'בקשת עזרה, למידת עמיתים', source: 'MSLQ', stage: 1 },
              { title: 'העדפות אישיות', metrics: 'העדפות תוכן, למידה שיתופית/אישית', source: 'דיווח עצמי', stage: 1 }
            ]
          },
          {
            id: 'identity',
            title: 'מסע זהות',
            icon: <Icons.Compass size={24} />,
            color: 'from-indigo-400 to-indigo-600',
            bgSolid: 'bg-indigo-500',
            bgColor: 'bg-indigo-100',
            borderColor: 'border-indigo-200',
            textColor: 'text-indigo-800',
            subDomains: [
              { title: 'ערכים', metrics: 'בהירות, הזדהות ומימוש ערכים', source: '', stage: 2 },
              { title: 'זהות אישית', metrics: '', source: '', stage: 2 }
            ]
          },
          {
            id: 'cognitive',
            title: 'קוגניציה',
            icon: <Icons.Brain size={24} />,
            color: 'from-teal-400 to-teal-600',
            bgSolid: 'bg-teal-500',
            bgColor: 'bg-teal-100',
            borderColor: 'border-teal-200',
            textColor: 'text-teal-800',
            subDomains: [
              { title: 'קשב וריכוז', metrics: 'רמת קשב, היפראקטיביות', source: '', stage: 2 },
              { title: 'עיכוב תגובה', metrics: 'אינהיביציה', source: '', stage: 2 },
              { title: 'אינטלגנציה', metrics: 'גורם G, רגשית', source: '', stage: 2 },
              { title: 'זכרון', metrics: 'זכרון עבודה, ידע כללי', source: '', stage: 2 },
              { title: 'לקויות למידה', metrics: 'דיסלקציה, דיסגרפיה', source: '', stage: 2 },
              { title: 'עומס קוגניטיבי', metrics: 'פנימי/חיצוני', source: '', stage: 2 }
            ]
          },
          {
            id: 'ems_data',
            title: 'נתוני EMS',
            icon: <Icons.FileText size={24} />,
            color: 'from-slate-500 to-slate-700',
            bgSolid: 'bg-slate-600',
            bgColor: 'bg-slate-200',
            borderColor: 'border-slate-300',
            textColor: 'text-slate-800',
            subDomains: [
              { title: 'מקצועות ומגמות', metrics: '', source: '', stage: 2 },
              { title: 'תיק תלמיד', metrics: '', source: '', stage: 2 },
              { title: 'הערות, תעודות', metrics: '', source: '', stage: 2 },
              { title: 'התאמות', metrics: 'פדגוגיות וטכנולוגיות', source: '', stage: 2 },
              { title: 'זמן למידה', metrics: 'זמן במשימות/ש"ב', source: '', stage: 2 },
              { title: 'מטרות ויעדים', metrics: 'שאיפות אקדמיות', source: '', stage: 2 }
            ]
          }
        ];

        // --- MATH HELPERS ---
        const toRad = (deg) => (deg * Math.PI) / 180;
        const calculatePosition = (angleDeg, radius, centerX, centerY) => {
          const rad = toRad(angleDeg);
          return {
            x: centerX + Math.cos(rad) * radius,
            y: centerY + Math.sin(rad) * radius
          };
        };

        // --- COMPONENTS ---

        // Controls (Filter + Reset)
        const Controls = ({ activeFilter, onFilterChange, onReset, scale }) => {
          return (
            <div className="flex gap-2 items-center">
              <div className="flex bg-white/90 backdrop-blur p-1 rounded-lg shadow-sm border border-gray-200 gap-1">
                {[ {l:'הכל',v:0}, {l:'שלב הטמעה ראשוני',v:1} ].map((opt) => (
                  <button
                    key={opt.v}
                    onClick={() => onFilterChange(opt.v)}
                    className={`px-3 py-1 rounded-md text-xs font-bold transition-all duration-200 ${
                      activeFilter === opt.v ? 'bg-blue-100 text-blue-700 shadow-sm' : 'text-gray-500 hover:bg-gray-100'
                    }`}
                  >
                    {opt.l}
                  </button>
                ))}
              </div>
              <button onClick={onReset} className="p-1.5 bg-white/90 rounded-lg shadow-sm border border-gray-200 text-gray-500 hover:text-gray-800" title="אפס תצוגה">
                <Icons.Compass size={18} />
              </button>
              <div className="px-2 py-1 bg-white/50 rounded text-[10px] text-gray-400 font-mono">
                {Math.round(scale * 100)}%
              </div>
            </div>
          );
        };

        const DetailModal = ({ subDomain, colorTheme, onClose }) => {
          if (!subDomain) return null;
          return (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/20 backdrop-blur-sm animate-fadeIn" onWheel={(e) => e.stopPropagation()}>
              <div 
                className={`relative w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden border-t-8 ${colorTheme.borderColor} flex flex-col max-h-[80vh] animate-flyOut`}
                style={{'--start-x': '50%', '--start-y': '50%', '--end-x': '50%', '--end-y': '50%'}} // Reuse animation roughly
                onClick={(e) => e.stopPropagation()}
              >
                <button onClick={onClose} className="absolute top-3 left-3 p-1.5 bg-gray-50 hover:bg-gray-100 rounded-full transition-colors z-10">
                  <Icons.X size={18} className="text-gray-600" />
                </button>
                <div className={`p-5 bg-gradient-to-r ${colorTheme.color} bg-opacity-10`}>
                  <div className="flex items-center gap-2 mb-2">
                    <span className="px-2 py-0.5 bg-white/20 backdrop-blur-md rounded text-white text-[10px] font-bold border border-white/30">
                       שלב {subDomain.stage}
                    </span>
                  </div>
                  <h3 className="text-xl font-bold text-white mb-1 drop-shadow-md pr-6">{subDomain.title}</h3>
                </div>
                <div className="p-5 space-y-4 bg-white overflow-y-auto custom-scrollbar">
                  {subDomain.metrics && (
                    <div>
                      <div className={`flex items-center gap-2 mb-2 font-bold text-sm ${colorTheme.textColor}`}>
                        <Icons.Activity size={16} /><h4>פירוט מדדים</h4>
                      </div>
                      <div className="bg-gray-50 p-3 rounded-lg border border-gray-100 text-gray-700 text-sm">{subDomain.metrics}</div>
                    </div>
                  )}
                  {subDomain.source && (
                    <div>
                      <div className="flex items-center gap-2 mb-1 text-gray-400 font-semibold text-xs uppercase">
                        <Icons.Database size={14} /><h4>מקור נתונים</h4>
                      </div>
                      <div className="flex items-center">
                         <div className={`h-4 w-1 ${colorTheme.bgSolid} rounded-full ml-2 opacity-50`}></div>
                         <p className="text-gray-600 text-xs font-medium">{subDomain.source}</p>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        };

        const Line = ({ x1, y1, x2, y2, isActive, isDashed = false }) => {
          const dx = x2 - x1;
          const dy = y2 - y1;
          const dist = Math.sqrt(dx*dx + dy*dy);
          const angle = Math.atan2(dy, dx) * (180 / Math.PI);
          return (
            <div className="absolute z-0 pointer-events-none origin-left"
              style={{
                top: y1, left: x1, width: `${dist}px`, height: isDashed ? '0' : '2px',
                borderTop: isDashed ? '2px dashed #cbd5e1' : 'none',
                backgroundColor: isDashed ? 'transparent' : (isActive ? '#94a3b8' : '#e2e8f0'), 
                transform: `rotate(${angle}deg)`, opacity: isActive ? 1 : 0.6, transition: 'opacity 0.5s' 
              }}
            />
          );
        };

        const NodeButton = ({ title, colorClass, textColor, bgSolid, onClick, pos, size, delay, isCategory = false }) => {
            const style = {
                '--start-x': `${pos.x}px`, '--start-y': `${pos.y}px`, '--end-x': `${pos.x}px`, '--end-y': `${pos.y}px`,
                width: size, height: size, left: pos.x, top: pos.y, animationDelay: `${delay}ms`
            };
            return (
                <button onClick={onClick} style={style}
                    className={`absolute rounded-full shadow-lg border border-gray-200 flex flex-col items-center justify-center p-2
                                hover:border-blue-400 hover:scale-105 transition-transform duration-300 z-40 animate-flyOut forwards
                                ${isCategory ? 'bg-white ring-2 ring-offset-1 ring-blue-100' : 'bg-white'} `}>
                    <span className={`font-bold text-center leading-tight ${textColor} line-clamp-3`} style={{ fontSize: size * 0.14 }}>{title}</span>
                    <div className={`mt-1 h-0.5 w-3 rounded-full ${bgSolid} opacity-30`}></div>
                    {isCategory && <div className="absolute -bottom-1 w-1.5 h-1.5 bg-blue-400 rounded-full animate-pulse"></div>}
                </button>
            );
        };

        // --- PAN & ZOOM WRAPPER ---
        const PanZoomWrapper = ({ children, contentSize, onResetRef }) => {
            const [transform, setTransform] = useState({ x: 0, y: 0, scale: 1 });
            const [isDragging, setIsDragging] = useState(false);
            const startPan = useRef({ x: 0, y: 0 });
            const containerRef = useRef(null);

            // Expose reset function
            useEffect(() => {
                if (onResetRef) onResetRef.current = () => setTransform({ x: 0, y: 0, scale: 1 });
            }, [onResetRef]);

            const handleMouseDown = (e) => {
                if (e.button !== 0) return; // Only left click
                setIsDragging(true);
                startPan.current = { x: e.clientX - transform.x, y: e.clientY - transform.y };
            };

            const handleMouseMove = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                setTransform(prev => ({ ...prev, x: e.clientX - startPan.current.x, y: e.clientY - startPan.current.y }));
            };

            const handleMouseUp = () => setIsDragging(false);

            const handleWheel = (e) => {
                // e.preventDefault(); // Sometimes interferes with browser scroll if not fullscreen
                const scaleAmount = -e.deltaY * 0.001;
                const newScale = Math.min(Math.max(0.5, transform.scale * (1 + scaleAmount)), 3);
                setTransform(prev => ({ ...prev, scale: newScale }));
            };

            return (
                <div 
                    ref={containerRef}
                    className={`w-full h-full overflow-hidden relative bg-slate-50 ${isDragging ? 'cursor-grabbing' : 'cursor-grab'}`}
                    onMouseDown={handleMouseDown}
                    onMouseMove={handleMouseMove}
                    onMouseUp={handleMouseUp}
                    onMouseLeave={handleMouseUp}
                    onWheel={handleWheel}
                >
                    <div 
                        style={{
                            transform: `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`,
                            transformOrigin: 'center',
                            transition: isDragging ? 'none' : 'transform 0.1s ease-out',
                            width: '100%', height: '100%'
                        }}
                    >
                        {children(transform.scale)}
                    </div>
                </div>
            );
        };

        const App = () => {
          const containerRef = useRef(null);
          const resetZoomRef = useRef(null);
          const [dimensions, setDimensions] = useState({ width: 0, height: 0, cx: 0, cy: 0 });
          const [activeDomainId, setActiveDomainId] = useState(null);
          const [activeCategoryId, setActiveCategoryId] = useState(null); // For Level 2 categories
          const [selectedSubDomain, setSelectedSubDomain] = useState(null); // For Modal
          const [stageFilter, setStageFilter] = useState(0); 

          // Filter Logic (Recursive for nested skills)
          const filteredData = useMemo(() => {
            return rawData.map(domain => {
                // Filter direct subDomains
                const visibleSubs = domain.subDomains.filter(sub => {
                    // Check direct stage
                    const selfMatch = stageFilter === 0 || sub.stage === 1;
                    // Check children stage (if category)
                    const childrenMatch = sub.children && sub.children.some(c => stageFilter === 0 || c.stage === 1);
                    return selfMatch || childrenMatch;
                }).map(sub => {
                    // If it has children, filter them too
                    if (sub.children) {
                        return {
                            ...sub,
                            children: sub.children.filter(c => stageFilter === 0 || c.stage === 1)
                        };
                    }
                    return sub;
                });
                return { ...domain, subDomains: visibleSubs };
            }).filter(d => d.subDomains.length > 0);
          }, [stageFilter]);

          // Reset selections on filter change
          useEffect(() => {
            setActiveDomainId(null);
            setActiveCategoryId(null);
            setSelectedSubDomain(null);
            if(resetZoomRef.current) resetZoomRef.current(); // Optional: reset zoom on filter change? maybe not.
          }, [stageFilter]);

          useLayoutEffect(() => {
            const updateDimensions = () => {
                setDimensions({ 
                    width: window.innerWidth, 
                    height: window.innerHeight, 
                    cx: window.innerWidth / 2, 
                    cy: window.innerHeight / 2 
                });
            };
            window.addEventListener('resize', updateDimensions);
            updateDimensions();
            return () => window.removeEventListener('resize', updateDimensions);
          }, []);

          const handleDomainClick = (id) => {
            if (activeDomainId === id) {
                setActiveDomainId(null);
                setActiveCategoryId(null);
            } else {
                setActiveDomainId(id);
                setActiveCategoryId(null);
            }
          };

          const handleSubClick = (sub) => {
             if (sub.isCategory) {
                 // Open Level 3
                 setActiveCategoryId(activeCategoryId === sub.id ? null : sub.id);
             } else {
                 // Open Modal
                 setSelectedSubDomain(sub);
             }
          };

          const activeDomainObj = filteredData.find(d => d.id === activeDomainId);

          // Geometry Constants
          const minDim = Math.min(dimensions.width, dimensions.height);
          // Scale base sizes slightly smaller to allow zoom expansion
          const MAIN_RADIUS = 220; 
          const SUB_RADIUS_OFFSET = 160; 
          const LEVEL3_RADIUS_OFFSET = 80; // Extra distance for level 3
          const CENTER_SIZE = 120;
          const MAIN_NODE_SIZE = 90;
          const SUB_NODE_SIZE = 75;
          const LEVEL3_NODE_SIZE = 65;

          return (
            <div className="h-full w-full bg-slate-50 flex flex-col font-sans overflow-hidden text-right" dir="rtl">
              <header className="bg-white/90 backdrop-blur-sm shadow-sm p-3 z-50 relative border-b border-gray-100 flex-shrink-0 flex items-center justify-between px-6">
                <h1 className="text-lg font-bold text-gray-800">פרופיל לומד</h1>
                {/* We pass scale=1 initially, updated inside wrapper */}
                <Controls activeFilter={stageFilter} onFilterChange={setStageFilter} onReset={() => resetZoomRef.current && resetZoomRef.current()} scale={1} />
              </header>

              <main className="flex-1 relative overflow-hidden w-full h-full">
                <PanZoomWrapper onResetRef={resetZoomRef}>
                 {(currentScale) => (
                  <>
                    {/* Background Aura */}
                    <div className="absolute inset-0 pointer-events-none flex items-center justify-center">
                       <div className={`rounded-full blur-[100px] transition-all duration-1000 opacity-20`}
                         style={{ width: '800px', height: '800px', backgroundColor: activeDomainObj ? '' : '#dbeafe' }}>
                         {activeDomainObj && <div className={`w-full h-full rounded-full ${activeDomainObj.bgColor || 'bg-gray-100'} transition-colors duration-1000`}></div>}
                       </div>
                    </div>

                    {/* Center Node */}
                    <div className="absolute z-20 flex flex-col items-center justify-center rounded-full shadow-2xl bg-white border-4 border-slate-50 text-slate-800 cursor-pointer hover:shadow-xl transition-all duration-300"
                      style={{ width: CENTER_SIZE, height: CENTER_SIZE, left: dimensions.cx, top: dimensions.cy, transform: 'translate(-50%, -50%)' }}
                      onClick={(e) => { e.stopPropagation(); setActiveDomainId(null); }}>
                       <Icons.User size={32} className="text-slate-400 mb-1 opacity-50"/>
                       <h2 className="font-extrabold text-center leading-none text-sm">פרופיל<br/>לומד</h2>
                       {stageFilter !== 0 && <span className="text-[10px] mt-1 bg-gray-100 text-gray-500 px-2 rounded-full">שלב 1</span>}
                    </div>

                    {/* Level 1: Main Nodes */}
                    {filteredData.map((domain, i) => {
                      const angleDeg = (360 / filteredData.length) * i - 90;
                      const pos = calculatePosition(angleDeg, MAIN_RADIUS, dimensions.cx, dimensions.cy);
                      const isActive = activeDomainId === domain.id;
                      const isDimmed = activeDomainId && !isActive;

                      return (
                        <React.Fragment key={domain.id}>
                          <Line x1={dimensions.cx} y1={dimensions.cy} x2={pos.x} y2={pos.y} isActive={isActive} />
                          
                          <button onClick={(e) => { e.stopPropagation(); handleDomainClick(domain.id); }}
                            className={`absolute rounded-full shadow-md flex flex-col items-center justify-center text-center 
                              transition-all duration-500 z-30 border-2 border-white group outline-none
                              bg-gradient-to-br ${domain.color} text-white
                              ${isActive ? 'scale-110 ring-4 ring-offset-2 ring-blue-50' : 'hover:scale-105'}
                              ${isDimmed ? 'opacity-40 grayscale scale-90' : 'opacity-100'} `}
                            style={{ width: MAIN_NODE_SIZE, height: MAIN_NODE_SIZE, left: pos.x, top: pos.y, transform: 'translate(-50%, -50%)' }}>
                            <div className="mb-0.5 opacity-95">{React.cloneElement(domain.icon, { size: 20 })}</div>
                            <span className="font-bold px-1 line-clamp-2 text-[11px]">{domain.title}</span>
                          </button>

                          {/* Level 2: Sub Nodes (or Categories) */}
                          {isActive && domain.subDomains.map((sub, j) => {
                            const subCount = domain.subDomains.length;
                            const spread = 80; 
                            const startAngle = angleDeg - (spread / 2);
                            const step = subCount > 1 ? spread / (subCount - 1) : 0;
                            const subAngle = subCount === 1 ? angleDeg : startAngle + (step * j);
                            const subPos = calculatePosition(subAngle, MAIN_RADIUS + SUB_RADIUS_OFFSET, dimensions.cx, dimensions.cy);
                            const isCatActive = activeCategoryId === sub.id;

                            return (
                              <React.Fragment key={sub.title + j}>
                                <Line x1={pos.x} y1={pos.y} x2={subPos.x} y2={subPos.y} isActive={true} isDashed={true} />
                                <NodeButton 
                                    title={sub.title} 
                                    colorClass={domain.color} 
                                    textColor={domain.textColor} 
                                    bgSolid={domain.bgSolid}
                                    onClick={(e) => { e.stopPropagation(); handleSubClick(sub); }}
                                    pos={subPos} 
                                    size={SUB_NODE_SIZE} 
                                    delay={j * 50}
                                    isCategory={sub.isCategory}
                                />

                                {/* Level 3: Children of Categories */}
                                {sub.isCategory && isCatActive && sub.children && sub.children.map((child, k) => {
                                    const childCount = sub.children.length;
                                    const childSpread = 70; // Wider spread for level 3
                                    // Base the angle on the Level 2 angle to continue outward
                                    const childStartAngle = subAngle - (childSpread / 2);
                                    const childStep = childCount > 1 ? childSpread / (childCount - 1) : 0;
                                    const childAngle = childCount === 1 ? subAngle : childStartAngle + (childStep * k);
                                    const childPos = calculatePosition(childAngle, MAIN_RADIUS + SUB_RADIUS_OFFSET + LEVEL3_RADIUS_OFFSET, dimensions.cx, dimensions.cy);

                                    return (
                                        <React.Fragment key={child.title + k}>
                                            <Line x1={subPos.x} y1={subPos.y} x2={childPos.x} y2={childPos.y} isActive={true} isDashed={true} />
                                            <NodeButton 
                                                title={child.title}
                                                colorClass={domain.color}
                                                textColor={domain.textColor}
                                                bgSolid={domain.bgSolid}
                                                onClick={(e) => { e.stopPropagation(); setSelectedSubDomain(child); }}
                                                pos={childPos}
                                                size={LEVEL3_NODE_SIZE}
                                                delay={k * 50}
                                            />
                                        </React.Fragment>
                                    );
                                })}
                              </React.Fragment>
                            );
                          })}
                        </React.Fragment>
                      );
                    })}
                  </>
                 )}
                </PanZoomWrapper>

                {/* Modal (Fixed position, ignore pan/zoom) */}
                {selectedSubDomain && activeDomainObj && (
                  <DetailModal 
                    subDomain={selectedSubDomain}
                    colorTheme={activeDomainObj}
                    onClose={() => setSelectedSubDomain(null)}
                  />
                )}
              </main>

              <footer className="p-2 text-center text-gray-400 text-xs font-light tracking-wider bg-slate-50 border-t border-slate-100 flex-shrink-0 z-50 relative">
                מו&quot;פ אמית
              </footer>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
