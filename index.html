<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>פרופיל לומד הוליסטי</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap');
        
        body { font-family: 'Heebo', sans-serif; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Fly Out Animation */
        .animate-flyOut {
          animation: flyOut 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
          opacity: 0;
          /* Start position is set via CSS vars in JS */
          left: var(--start-x);
          top: var(--start-y);
          transform: translate(-50%, -50%) scale(0.2);
        }

        @keyframes flyOut {
          to {
            opacity: 1;
            left: var(--end-x);
            top: var(--end-y);
            transform: translate(-50%, -50%) scale(1);
          }
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-50 h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useLayoutEffect, useMemo } = React;

        // --- ICONS (Inline SVG components to avoid dependencies) ---
        const IconBase = ({ size = 24, children, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round"
                className={className}
            >
                {children}
            </svg>
        );

        const Icons = {
            User: (p) => <IconBase {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>,
            BookOpen: (p) => <IconBase {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>,
            Brain: (p) => <IconBase {...p}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></IconBase>,
            Heart: (p) => <IconBase {...p}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></IconBase>,
            Activity: (p) => <IconBase {...p}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconBase>,
            Target: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>,
            Compass: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></IconBase>,
            Zap: (p) => <IconBase {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>,
            Sparkles: (p) => <IconBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 5h4"/><path d="M3 7.502h4"/><path d="M7 3.502v4"/></IconBase>,
            X: (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>,
            Database: (p) => <IconBase {...p}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></IconBase>,
            Info: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconBase>,
            FileText: (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></IconBase>
        };

        // --- DATA STRUCTURE (29.11 Draft) ---
        const rawData = [
          {
            id: 'personal',
            title: 'נתונים אישיים',
            icon: <Icons.User size={24} />,
            color: 'from-blue-400 to-blue-600',
            bgSolid: 'bg-blue-500',
            bgColor: 'bg-blue-100',
            borderColor: 'border-blue-200',
            textColor: 'text-blue-800',
            subDomains: [
              { title: 'נתונים דמוגרפיים', metrics: 'גיל, מגדר, שכבת גיל, שפת אם, סטטוס משפחתי של ההורים, מצב סוציואקונומי (מדד טיפוח של בי"ס)', source: 'נתוני בית ספר', stage: 1 },
              { title: 'תחומי עניין', metrics: 'תחביבים, תחומי עניין אישיים, כישורים מיוחדים', source: 'דיווח עצמי תלמיד', stage: 1 },
              { title: 'התאמות בלמידה', metrics: 'התאמות פדגוגיות או טכנולוגיות הניתנות ללומד לצורך למידה מיטבית (כגון: הארכת זמן, סיוע בקריאה, סביבה מותאמת).', source: 'נתוני בית ספר', stage: 2 }
            ]
          },
          {
            id: 'personality',
            title: 'מאפיינים אישיותיים',
            icon: <Icons.Sparkles size={24} />,
            color: 'from-purple-400 to-purple-600',
            bgSolid: 'bg-purple-500',
            bgColor: 'bg-purple-100',
            borderColor: 'border-purple-200',
            textColor: 'text-purple-800',
            subDomains: [
              { title: 'תכונות אישיות', metrics: 'פתיחות להתנסויות, מוחצנות, נועם הליכות, מצפוניות, יציבות רגשית', source: 'שאלון דיווח עצמי לתלמיד - TIPI', stage: 2 }
            ]
          },
          {
            id: 'knowledge',
            title: 'ידע',
            subtitle: 'מחולק למקצוע ולנושאי לימוד',
            icon: <Icons.BookOpen size={24} />,
            color: 'from-emerald-400 to-emerald-600',
            bgSolid: 'bg-emerald-500',
            bgColor: 'bg-emerald-100',
            borderColor: 'border-emerald-200',
            textColor: 'text-emerald-800',
            subDomains: [
              { title: 'רמת שליטה בידע ספציפי', metrics: 'ידע עולם, ידע קודם רלוונטי', source: 'נתוני למידה', stage: 1 },
              { title: 'התמודדות עם רמת קושי של שאלה', metrics: '', source: 'נתוני למידה', stage: 1 },
              { title: 'התמודדות עם רמת חשיבה', metrics: 'רמת חשיבה', source: 'נתוני למידה', stage: 1 }
            ]
          },
          {
            id: 'skills',
            title: 'מיומנויות',
            icon: <Icons.Zap size={24} />,
            color: 'from-rose-400 to-rose-600',
            bgSolid: 'bg-rose-500',
            bgColor: 'bg-rose-100',
            borderColor: 'border-rose-200',
            textColor: 'text-rose-800',
            subDomains: [
              { title: 'מיומנויות חברתיות', metrics: 'תקשורת - העברת מסר, עבודת צוות, מודעות והתנהלות חברתית', source: 'דיווח מורה', stage: 2 },
              { title: 'מיומנויות רגשיות', metrics: 'מודעות עצמית, הכוונה עצמית', source: 'דיווח מורה', stage: 2 },
              { title: 'מיומנויות תפקודיות', metrics: 'ניהול עצמי, חוסן, גמישות, קבלת החלטות', source: 'דיווח מורה', stage: 2 },
              { title: 'אוריינות לשונית', metrics: 'איתור מידע, פרשנות והיסק ממקור בודד/מקורות מרובים, הבעה בכתב, הבעה בעל פה', source: 'נתוני למידה', stage: 2 },
              { title: 'חשיבה ביקורתית', metrics: 'טיעון', source: 'נתוני למידה', stage: 2 },
              { title: 'חשיבה יצירתית', metrics: 'סקרנות ומקוריות, גמישות מחשבתית, יצירת הקשרים חדשים', source: 'נתוני למידה', stage: 2 },
              { title: 'אוריינות דיגיטלית', metrics: 'תפעול ופתרון בעיות, שיתופיות, יצירת תוכן במדיה הדיגיטלית', source: 'נתוני למידה', stage: 2 },
              { title: 'אוריינות מידע', metrics: 'איתור מידע, הערכת מידע, ארגון מידע, שימוש במידע, הצגת מידע (כולל מיזוג מידע, השוואה, התמצאות במפה)', source: 'נתוני למידה', stage: 2 },
              { title: 'מיומנויות דיסציפלינריות', metrics: '(רשימה נפרדת לכל תחום דעת)', source: 'נתוני למידה', stage: 1 },
              { title: 'תכנון למידה', metrics: 'תכנון מטרות, תכנון אסטרטגיות, תכנון זמן, תכנון משאבים וסביבת למידה', source: 'יומן למידה / שאלון דיווח עצמי לתלמיד - MSLQ', stage: 2 },
              { title: 'ויסות עצמי מטא-קוגניטיבי', metrics: 'תכנון, ניטור ההבנה, ויסות ובקרה של הלמידה, הבהרה ותיקון כשיש אי־הבנה.', source: 'שאלון דיווח עצמי לתלמיד - MSLQ', stage: 2 },
              { title: 'שימוש באסטרטגיות למידה', metrics: 'למידה שטחית / מעמיקה, שינון, עיבוד, ארגון, חשיבה ביקורתית, חשיבה רפלקטיבית', source: 'נתוני למידה / יומן למידה / שאלון דיווח עצמי לתלמיד - MSLQ, RSPQ-2F', stage: 2 },
              { title: 'מודעות לידע', metrics: 'שיפוט למידה, שיפוט הבנה, בטחון בתשובה, תחושת ידע', source: 'JOL, JOU, RCJ, FOK שאלות מסוג', stage: 1 }
            ]
          },
          {
            id: 'self_beliefs',
            title: 'אמונות ביחס לעצמי',
            icon: <Icons.Target size={24} />,
            color: 'from-cyan-400 to-cyan-600',
            bgSolid: 'bg-cyan-500',
            bgColor: 'bg-cyan-100',
            borderColor: 'border-cyan-200',
            textColor: 'text-cyan-800',
            subDomains: [
              { title: 'מסוגלות עצמית ללמידה', metrics: '', source: 'שאלון דיווח עצמי לתלמיד - MSLQ', stage: 1 },
              { title: 'תודעת צמיחה', metrics: '', source: 'שאלון דיווח עצמי לתלמיד - ITIS-S', stage: 1 }
            ]
          },
          {
            id: 'social_emotional',
            title: 'רגשי-חברתי',
            icon: <Icons.Heart size={24} />,
            color: 'from-orange-400 to-orange-600',
            bgSolid: 'bg-orange-500',
            bgColor: 'bg-orange-100',
            borderColor: 'border-orange-200',
            textColor: 'text-orange-800',
            subDomains: [
              { title: 'צרכי עומק', metrics: 'קשר, שייכות, בטחון, אוטונומיה, בירור מצפן פנימי, תחושת מסוגלות כללית', source: 'שאלוני תצאמ', stage: 1 },
              { title: 'מוטיבציה', metrics: 'סוג מוטיבציה - פנימית / חיצונית / מתריסה, עוצמת המוטיבציה', source: 'שאלון דיווח עצמי לתלמיד - MSLQ', stage: 1 },
              { title: 'הנאה מלמידה', metrics: 'רגש חיובי כלפי הלמידה, עניין באתגור אקדמי (need for cognition), זרימה', source: 'שאלון דיוווח עצמי לתלמיד - PANAS-C, NCS-6', stage: 2 },
              { title: 'שייכות חברתית', metrics: 'מידת השייכות לקבוצה, מידת השייכות לבית ספר, מעורבות חברתית', source: 'שאלון דיווח עצמי לתלמיד - NOD, PSSM-H, דיווח מורה', stage: 2 },
              { title: 'רגש', metrics: 'חיוביות-שליליות, אופטימיות, שעמום, בלבול, תסכול', source: 'שאלון דיווח עצמי לתלמיד - PANAS-C', stage: 2 },
              { title: 'לחץ וחרדה', metrics: 'לחץ, רמת חרדה בלמידה, חרדה מתמטית, חרדת שפה זרה, חרדת בחינות', source: 'שאלוני דיווח עצמי לתלמיד - MAS-12, PHCC TAQ-10 ...', stage: 2 }
            ]
          },
          {
            id: 'srl',
            title: 'מוכוונות עצמית (SRL)',
            subtitle: 'וניהול למידה',
            icon: <Icons.Activity size={24} />,
            color: 'from-amber-400 to-amber-600',
            bgSolid: 'bg-amber-500',
            bgColor: 'bg-amber-100',
            borderColor: 'border-amber-200',
            textColor: 'text-amber-800',
            subDomains: [
              { title: 'מעורבות בלמידה', metrics: 'השתתפות כוללת בפעילויות למידה, השתתפות בדיונים, תגובה במשימות סינכרוניות וא־סינכרוניות', source: 'נתוני למידה', stage: 1 },
              { title: 'התמדה', metrics: 'נוכחות, מאמץ ועקביות בהשקעה לאורך זמן, השקעת זמן בתרגול, השקעה בתנאים או זמנים מאתגרים, גריט', source: 'נתוני למידה, שאלון דיווח עצמי לתלמיד - Grit-S', stage: 1 },
              { title: 'סדירות למידה', metrics: 'זמני למידה, דחיינות', source: 'שאלון דיווח עצמי לתלמיד - MSLQ', stage: 1 },
              { title: 'היעזרות', metrics: 'היעזרות, למידת עמיתים, פתיחות למישוב', source: 'שאלון דיווח עצמי לתלמיד - MSLQ', stage: 1 },
              { title: 'העדפות אישיות בלמידה', metrics: 'העדפה לסוג תוכן, העדפה ללמידה אישית או שיתופית, מישחוק, העשרה', source: 'דיווח עצמי תלמיד', stage: 1 }
            ]
          },
          {
            id: 'identity',
            title: 'מסע זהות',
            icon: <Icons.Compass size={24} />,
            color: 'from-indigo-400 to-indigo-600',
            bgSolid: 'bg-indigo-500',
            bgColor: 'bg-indigo-100',
            borderColor: 'border-indigo-200',
            textColor: 'text-indigo-800',
            subDomains: [
              { title: 'ערכים', metrics: 'בהירות הערכים, ההזדהות עם הערכים, מימוש הערכים', source: '', stage: 2 },
              { title: 'זהות אישית', metrics: '', source: '', stage: 2 }
            ]
          },
          {
            id: 'cognitive',
            title: 'מאפיינים קוגניטיביים',
            icon: <Icons.Brain size={24} />,
            color: 'from-teal-400 to-teal-600',
            bgSolid: 'bg-teal-500',
            bgColor: 'bg-teal-100',
            borderColor: 'border-teal-200',
            textColor: 'text-teal-800',
            subDomains: [
              { title: 'קשב וריכוז, היפראקטיביות', metrics: 'רמת קשב, היפראקטיביות', source: '', stage: 2 },
              { title: 'עיכוב תגובה', metrics: 'עיכוב תגובה', source: '', stage: 2 },
              { title: 'אינטלגנציה', metrics: 'גורם G (אינטלגנציה כללית), אינטלגנציה רגשית', source: '', stage: 2 },
              { title: 'זכרון', metrics: 'זכרון עבודה, ידע כללי', source: '', stage: 2 },
              { title: 'לקויות למידה', metrics: 'דיסלקציה, דיסגרפיה, דיסקלקוליה', source: '', stage: 2 },
              { title: 'עומס קוגניטיבי', metrics: 'עומס פנימי, עומס חיצוני', source: '', stage: 2 }
            ]
          },
          {
            id: 'ems_data',
            title: 'נתוני EMS',
            icon: <Icons.FileText size={24} />,
            color: 'from-slate-500 to-slate-700',
            bgSolid: 'bg-slate-600',
            bgColor: 'bg-slate-200',
            borderColor: 'border-slate-300',
            textColor: 'text-slate-800',
            subDomains: [
              { title: 'מקצועות לימוד, מגמות, קבוצות', metrics: '', source: '', stage: 2 },
              { title: 'תיק תלמיד', metrics: '', source: '', stage: 2 },
              { title: 'הערות, תעודות', metrics: '', source: '', stage: 2 },
              { title: 'התאמות בלמידה', metrics: 'התאמות פדגוגיות או טכנולוגיות הניתנות ללומד לצורך למידה מיטבית (כגון: הארכת זמן, סיוע בקריאה, סביבה מותאמת)', source: '', stage: 2 },
              { title: 'זמן למידה', metrics: 'זמן שהוקדש ללמידה, זמן שהוקדש למשימות, זמן שהוקדש לשיעורי בית, עמידה בזמנים בפועל', source: '', stage: 2 },
              { title: 'מטרות ויעדים', metrics: 'שאיפות אקדמיות', source: '', stage: 2 }
            ]
          }
        ];

        // --- MATH HELPERS ---
        const toRad = (deg) => (deg * Math.PI) / 180;
        const calculatePosition = (angleDeg, radius, centerX, centerY) => {
          const rad = toRad(angleDeg);
          return {
            x: centerX + Math.cos(rad) * radius,
            y: centerY + Math.sin(rad) * radius
          };
        };

        // --- COMPONENTS ---

        const StageFilter = ({ activeFilter, onFilterChange }) => {
          const options = [
            { label: 'הכל', value: 0 },
            { label: 'שלב הטמעה ראשוני', value: 1 },
          ];

          return (
            <div className="flex bg-gray-100 p-1 rounded-lg shadow-inner gap-1">
              {options.map((opt) => (
                <button
                  key={opt.value}
                  onClick={() => onFilterChange(opt.value)}
                  className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all duration-200 ${
                    activeFilter === opt.value
                      ? 'bg-white text-blue-700 shadow-sm ring-1 ring-black/5'
                      : 'text-gray-500 hover:text-gray-700 hover:bg-gray-200/50'
                  }`}
                >
                  {opt.label}
                </button>
              ))}
            </div>
          );
        };

        const DetailModal = ({ subDomain, colorTheme, onClose }) => {
          if (!subDomain) return null;

          return (
            <div className="absolute inset-0 z-[100] flex items-center justify-center p-4 bg-white/40 backdrop-blur-md animate-fadeIn">
              <div 
                className={`relative w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden border-t-8 ${colorTheme.borderColor} flex flex-col max-h-[80vh]`}
                onClick={(e) => e.stopPropagation()}
              >
                <button 
                  onClick={onClose}
                  className="absolute top-3 left-3 p-1.5 bg-gray-50 hover:bg-gray-100 rounded-full transition-colors z-10"
                >
                  <Icons.X size={18} className="text-gray-600" />
                </button>

                <div className={`p-5 bg-gradient-to-r ${colorTheme.color} bg-opacity-10`}>
                  <div className="flex items-center gap-2 mb-2">
                    <span className="px-2 py-0.5 bg-white/20 backdrop-blur-md rounded text-white text-[10px] font-bold border border-white/30">
                       שלב {subDomain.stage}
                    </span>
                  </div>
                  <h3 className="text-xl font-bold text-white mb-1 drop-shadow-md pr-6">{subDomain.title}</h3>
                </div>
                
                <div className="p-5 space-y-4 bg-white overflow-y-auto custom-scrollbar">
                  {subDomain.metrics && (
                    <div>
                      <div className={`flex items-center gap-2 mb-2 font-bold text-sm ${colorTheme.textColor}`}>
                        <Icons.Activity size={16} />
                        <h4>פירוט מדדים</h4>
                      </div>
                      <div className="bg-gray-50 p-3 rounded-lg border border-gray-100">
                         <p className="text-gray-700 text-sm leading-relaxed">
                          {subDomain.metrics}
                        </p>
                      </div>
                    </div>
                  )}

                  {subDomain.source && (
                    <div>
                      <div className="flex items-center gap-2 mb-1 text-gray-400 font-semibold text-xs uppercase">
                        <Icons.Database size={14} />
                        <h4>מקור נתונים</h4>
                      </div>
                      <div className="flex items-center">
                         <div className={`h-4 w-1 ${colorTheme.bgSolid} rounded-full ml-2 opacity-50`}></div>
                         <p className="text-gray-600 text-xs font-medium">
                           {subDomain.source}
                         </p>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        };

        const Line = ({ x1, y1, x2, y2, isActive, isDashed = false }) => {
          const dx = x2 - x1;
          const dy = y2 - y1;
          const distance = Math.sqrt(dx * dx + dy * dy);
          const angle = Math.atan2(dy, dx) * (180 / Math.PI);

          return (
            <div
              className="absolute z-0 pointer-events-none origin-left"
              style={{
                top: y1,
                left: x1,
                width: `${distance}px`,
                height: isDashed ? '0px' : '2px',
                borderTop: isDashed ? '2px dashed #cbd5e1' : 'none',
                backgroundColor: isDashed ? 'transparent' : (isActive ? '#94a3b8' : '#e2e8f0'), 
                transform: `rotate(${angle}deg)`,
                opacity: isActive ? 1 : 0.6,
                transition: 'opacity 0.5s ease-out' 
              }}
            />
          );
        };

        const AnimatedSubNode = ({ 
          sub, 
          domain, 
          onClick, 
          startPos, 
          endPos, 
          size, 
          delay 
        }) => {
          
          const style = {
            '--start-x': `${startPos.x}px`,
            '--start-y': `${startPos.y}px`,
            '--end-x': `${endPos.x}px`,
            '--end-y': `${endPos.y}px`,
            width: size,
            height: size,
            animationDelay: `${delay}ms`
          };

          return (
            <button
              onClick={() => onClick(sub)}
              className="absolute bg-white rounded-full shadow-lg border border-gray-200 flex flex-col items-center justify-center p-2
                         hover:border-blue-400 hover:scale-105 transition-transform duration-300 z-40 animate-flyOut forwards"
              style={style}
            >
              <span 
                className={`font-bold text-center leading-tight ${domain.textColor} line-clamp-3`}
                style={{ fontSize: size * 0.13 }}
              >
                {sub.title}
              </span>
              <div className={`mt-1 h-0.5 w-3 rounded-full ${domain.bgSolid} opacity-30`}></div>
            </button>
          );
        };

        const App = () => {
          const containerRef = useRef(null);
          const [dimensions, setDimensions] = useState({ width: 0, height: 0, cx: 0, cy: 0 });
          const [activeDomainId, setActiveDomainId] = useState(null);
          const [selectedSubDomain, setSelectedSubDomain] = useState(null);
          const [stageFilter, setStageFilter] = useState(0); 

          const filteredData = useMemo(() => {
            return rawData
              .map(domain => ({
                ...domain,
                subDomains: domain.subDomains.filter(sub => stageFilter === 0 || sub.stage === 1)
              }))
              .filter(domain => domain.subDomains.length > 0);
          }, [stageFilter]);

          useEffect(() => {
            setActiveDomainId(null);
            setSelectedSubDomain(null);
          }, [stageFilter]);

          useLayoutEffect(() => {
            if (!containerRef.current) return;
            const updateDimensions = () => {
              if (containerRef.current) {
                const { width, height } = containerRef.current.getBoundingClientRect();
                setDimensions({ width, height, cx: width / 2, cy: height / 2 });
              }
            };
            updateDimensions();
            const observer = new ResizeObserver(updateDimensions);
            observer.observe(containerRef.current);
            return () => observer.disconnect();
          }, []);

          const handleDomainClick = (id) => {
            setActiveDomainId(prev => prev === id ? null : id);
          };

          const activeDomainObj = filteredData.find(d => d.id === activeDomainId);

          const minDim = Math.min(dimensions.width, dimensions.height);
          const MAIN_RADIUS = minDim * 0.28; 
          const SUB_RADIUS_OFFSET = minDim * 0.17; 
          const CENTER_NODE_SIZE = Math.max(80, minDim * 0.15); 
          const MAIN_NODE_SIZE = Math.max(60, minDim * 0.11);
          const SUB_NODE_SIZE = Math.max(50, minDim * 0.10);

          return (
            <div className="h-full w-full bg-slate-50 flex flex-col font-sans overflow-hidden text-right" dir="rtl">
              <header className="bg-white/90 backdrop-blur-sm shadow-sm p-3 z-50 relative border-b border-gray-100 flex-shrink-0 flex flex-col md:flex-row items-center justify-between gap-3 px-6">
                <h1 className="text-lg md:text-xl font-bold text-gray-800 tracking-tight">מבט הוליסטי על הלומד</h1>
                <StageFilter activeFilter={stageFilter} onFilterChange={setStageFilter} />
              </header>

              <main className="flex-1 relative overflow-hidden w-full h-full" ref={containerRef}>
                
                <div className="absolute inset-0 overflow-hidden pointer-events-none">
                   <div 
                     className={`absolute rounded-full blur-[80px] transition-all duration-1000 opacity-30`}
                     style={{
                        left: dimensions.cx,
                        top: dimensions.cy,
                        width: '60%',
                        height: '60%',
                        transform: 'translate(-50%, -50%)',
                        backgroundColor: activeDomainObj ? '' : '#dbeafe' 
                     }}
                   >
                     {activeDomainObj && (
                        <div className={`w-full h-full rounded-full ${activeDomainObj.bgColor || 'bg-gray-100'} transition-colors duration-1000`}></div>
                     )}
                   </div>
                </div>

                {dimensions.width > 0 && (
                  <>
                    <div 
                      className="absolute z-20 flex flex-col items-center justify-center rounded-full shadow-xl bg-white border-4 border-slate-50 text-slate-800 cursor-pointer hover:shadow-2xl transition-all duration-300"
                      style={{
                        width: CENTER_NODE_SIZE,
                        height: CENTER_NODE_SIZE,
                        left: dimensions.cx,
                        top: dimensions.cy,
                        transform: 'translate(-50%, -50%)'
                      }}
                      onClick={() => setActiveDomainId(null)}
                    >
                       <Icons.User size={CENTER_NODE_SIZE * 0.3} className="text-slate-400 mb-1 opacity-50"/>
                       <h2 className="font-extrabold text-center leading-none" style={{ fontSize: CENTER_NODE_SIZE * 0.14 }}>פרופיל<br/>לומד</h2>
                       {stageFilter !== 0 && (
                         <span className="text-[10px] mt-1 bg-gray-100 text-gray-500 px-2 rounded-full">שלב 1</span>
                       )}
                    </div>

                    {filteredData.map((domain, i) => {
                      const angleDeg = (360 / filteredData.length) * i - 90;
                      const pos = calculatePosition(angleDeg, MAIN_RADIUS, dimensions.cx, dimensions.cy);
                      const isActive = activeDomainId === domain.id;
                      const isDimmed = activeDomainId && !isActive;

                      return (
                        <React.Fragment key={domain.id}>
                          <Line 
                            x1={dimensions.cx} 
                            y1={dimensions.cy} 
                            x2={pos.x} 
                            y2={pos.y} 
                            isActive={isActive}
                          />

                          <button
                            onClick={() => handleDomainClick(domain.id)}
                            className={`absolute rounded-full shadow-md flex flex-col items-center justify-center text-center 
                              transition-all duration-500 z-30 border-2 border-white group outline-none
                              bg-gradient-to-br ${domain.color} text-white
                              ${isActive ? 'scale-110 ring-4 ring-offset-2 ring-blue-50' : 'hover:scale-105'}
                              ${isDimmed ? 'opacity-40 grayscale scale-90' : 'opacity-100'}
                            `}
                            style={{
                              width: MAIN_NODE_SIZE,
                              height: MAIN_NODE_SIZE,
                              left: pos.x,
                              top: pos.y,
                              transform: 'translate(-50%, -50%)'
                            }}
                          >
                            <div className="mb-0.5 opacity-95 group-hover:-translate-y-0.5 transition-transform">
                              {React.cloneElement(domain.icon, { size: MAIN_NODE_SIZE * 0.25 })}
                            </div>
                            <div className="flex flex-col leading-tight items-center justify-center w-full">
                              <span className="font-bold px-1 line-clamp-2" style={{ fontSize: MAIN_NODE_SIZE * 0.11 }}>
                                {domain.title}
                              </span>
                              {domain.subtitle && (
                                 <span className="opacity-80 font-normal mt-0.5 hidden md:block" style={{ fontSize: MAIN_NODE_SIZE * 0.08 }}>
                                   {domain.subtitle.substring(0, 15)}...
                                 </span>
                              )}
                            </div>
                          </button>

                          {isActive && domain.subDomains.map((sub, j) => {
                            const subCount = domain.subDomains.length;
                            const spread = 70; 
                            const startAngle = angleDeg - (spread / 2);
                            const step = subCount > 1 ? spread / (subCount - 1) : 0;
                            const subAngle = subCount === 1 ? angleDeg : startAngle + (step * j);
                            
                            const subPos = calculatePosition(subAngle, MAIN_RADIUS + SUB_RADIUS_OFFSET, dimensions.cx, dimensions.cy);

                            return (
                              <React.Fragment key={`${domain.id}-sub-${j}`}>
                                <Line 
                                  x1={pos.x} 
                                  y1={pos.y} 
                                  x2={subPos.x} 
                                  y2={subPos.y} 
                                  isActive={true}
                                  isDashed={true}
                                />

                                <AnimatedSubNode 
                                  sub={sub}
                                  domain={domain}
                                  onClick={setSelectedSubDomain}
                                  startPos={pos} 
                                  endPos={subPos} 
                                  size={SUB_NODE_SIZE}
                                  delay={j * 60}
                                />
                              </React.Fragment>
                            );
                          })}
                        </React.Fragment>
                      );
                    })}
                  </>
                )}

                {selectedSubDomain && activeDomainObj && (
                  <DetailModal 
                    subDomain={selectedSubDomain}
                    colorTheme={activeDomainObj}
                    onClose={() => setSelectedSubDomain(null)}
                  />
                )}
              </main>

              <footer className="p-2 text-center text-gray-400 text-xs font-light tracking-wider bg-slate-50 border-t border-slate-100 flex-shrink-0">
                מו&quot;פ אמית
              </footer>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
